---
- name: Install programs on Fedora
  hosts: localhost
  vars:
    tmp_folder: /tmp/ansible_temp
  become: yes
  tasks:

  - name: Check if SSM key already exists
    stat:
       path: "{{ tmp_folder }}/amazon-ssm-agent.gpg"
       register: file_status

  - name: Create temp download folder
    shell: |
       mkdir -p {{ tmp_folder }}
       mv ./amazon-ssm-agent.gpg {{ tmp_folder }}
    when: not file_status.stat.exists


  - name: Adding RPM Free repository into repo.d list
    yum_repository:
        name: RPM Fusion Free
        description: RPM Free repository
        baseurl: https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-{{ansible_distribution_major_version}}.noarch.rpm
        enabled: true
        gpgcheck: true
        gpgkey: https://rpmfusion.org/keys?action=AttachFile&do=get&target=RPM-GPG-KEY-rpmfusion-free-fedora-2020

  - name: Adding RPM Non Free repository into repo.d list
    yum_repository:
        name: RPM Fusion Non Free
        description: RPM Non Free repository
        baseurl: https://mirrors.rpmfusion.org/free/fedora/rpmfusion-nonfree-release-{{ansible_distribution_major_version}}.noarch.rpm
        enabled: true
        gpgcheck: true
        gpgkey: https://rpmfusion.org/keys?action=AttachFile&do=get&target=RPM-GPG-KEY-rpmfusion-nonfree-fedora-2020

  - name: Adding Google Chrome repository into repo.d list
    yum_repository:
        name: google-chrome
        description: google-chrome repository
        baseurl: http://dl.google.com/linux/chrome/rpm/stable/x86_64
        enabled: true
        gpgcheck: true
        gpgkey: https://dl.google.com/linux/linux_signing_key.pub

  - name: Adding Microsoft VSCode repository into repo.d list
    yum_repository:
        name: vscode
        description: vscode repository
        baseurl: https://packages.microsoft.com/yumrepos/vscode
        enabled: true
        gpgcheck: true
        gpgkey: https://packages.microsoft.com/keys/microsoft.asc
        
  - name: Adding Notion Repackged repository into repo.d list
    yum_repository:
        name: notion-repackged
        description: notion repackaged repository
        baseurl: https://yum.fury.io/notion-repackaged/
        enabled: true
        gpgcheck: false

  - name: Download AppImageLaucher
    shell: |
        cd "{{ tmp_folder }}"
        wget https://api.github.com/repos/TheAssassin/AppImageLauncher/releases/latest -O - | awk -F \" -v RS="," '/browser_download_url/ {print $(NF-1)}' | xargs wget
        rm -f appimagelauncher*.tar.xz
        rm -f appimagelauncher-lite*
        rm -f appimagelauncher*.arm*
        rm -f appimagelauncher*.deb
        rm -f appimagelauncher*-i386*
        find . -name "*.rpm" -exec mv {} ./appimagelauncher.rpm \;

  - name: Install AppImageLauncher
    dnf:
        name: "{{ tmp_folder }}/appimagelauncher.rpm"
        state: present
        disable_gpg_check: true
      
  - name: Add flathub repository
    command: flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo

  - name: Refreshing the repos cache
    shell: |
        yum update --refresh git-core
  
  - name: Install commom programs
    dnf:
      name: "{{ item }}"
      state: present
    with_items:
      - flatpak
      - vim
      - code
      - curl
      - wget
      - flameshot
      - yakuake
      - onedrive
      - firefox
      - qbittorrent
      - gwe #Gree with Envy - Nvidia Tweaks
      - google-chrome-stable
      - notion-app-enhanced
      
  - name: Install flatpak programs
    flatpak:
      name: "{{ item }}"
      remote: flathub
      state: present
    with_items:
      - com.meetfranz.Franz
      - com.notepadqq.Notepadqq
      - io.github.peazip.PeaZip
      - io.dbeaver.DBeaverCommunity
      - dev.aunetx.deezer

  - name: Install AppImageLauncher
    dnf:

  - name: Install AWS CLI
    shell: |
      cd "{{ tmp_folder }}"
      curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
      unzip awscliv2.zip
      sudo ./aws/install
      
  - name: Importing AWS SSM Plugin GPG Key
    rpm_key:
        state: present
        key: "{{ tmp_folder }}/amazon-ssm-agent.gpg"
       

  - name: Install AWS SSM Plugin
    dnf:
      name: https://s3.amazonaws.com/session-manager-downloads/plugin/latest/linux_64bit/session-manager-plugin.rpm
      state: present
       
  - name: Install OneDriveGui
    shell: |
       cd "{{ tmp_folder }}"
       wget https://api.github.com/repos/bpozdena/OneDriveGUI/releases/latest -O - | awk -F \" -v RS="," '/browser_download_url/ {print $(NF-1)}' | xargs wget
       find . -type f -name "*.txt" -exec ail-cli integrate {} \; 

  - name: Install Serverless Framework
    shell: |
        curl -o- -L https://slss.io/install | bash

  - name: Install Python 3.9 - Requirements
    dnf:
      name: "{{ item }}"
      state: present
    with_items:
      - wget 
      - yum-utils 
      - make 
      - gcc 
      - openssl-devel 
      - bzip2-devel 
      - libffi-devel 
      - zlib-devel 
  - name: Install Python 3.9 - Install
    shell: |
        cd "{{ tmp_folder }}"
        wget https://www.python.org/ftp/python/3.9.18/Python-3.9.18.tgz
        tar xzf Python-3.9.18.tgz
        cd Python-3.9.18
        sudo ./configure --with-system-ffi --with-computed-gotos --enable-loadable-sqlite-extensions
        sudo make -j
        sudo make altinstall
        cd "{{ tmp_folder }}"
   
  - name: Cleaing temp folder
    shell: |
        cd "{{ tmp_folder }}"
        rm -rf ./*.*
        
       
  

